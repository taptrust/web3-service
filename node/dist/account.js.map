{"version":3,"sources":["../src/account.js"],"names":["username","publicKey","pubKey","web3","utils","hexToBytes","tx","gas","toHex","to","FactoryAddress","data","FactoryContract","methods","createNewWallet","encodeABI","signingAccount","signTransaction","signedTx","console","log","rawTransaction","Promise","resolve","reject","eth","sendSignedTransaction","once","receipt","logs","topic","topics","address","substring","on","result","value","error","saveAccountAddress","user","createAccount","contractAddress","WalletContract","web3interface","getWalletContract","nextNonce","call","getUserNonce","Datastore","require","ProxyWalletABI","datastore","projectId","keyFilename","getUsers","query","createQuery","order","descending","limit","runQuery","then","results","entities","map","entity","contract_address","userKey","key","get","upsert"],"mappings":";;;;;;;;;;;;;;;;qFA+CA,iBAA6BA,QAA7B,EAAuCC,SAAvC;AAAA;AAAA;AAAA;AAAA;AAAA;AACKC,YADL,GACcC,KAAKC,KAAL,CAAWC,UAAX,CAAsBJ,SAAtB,CADd;AAGKK,QAHL,GAGU;AACRC,YAAMJ,KAAKC,KAAL,CAAWI,KAAX,CAAiB,OAAjB,CADE;AAERC,WAAIC,cAFI;AAGRC,aAAMC,gBAAgBC,OAAhB,CAAwBC,eAAxB,CAAwCZ,MAAxC,EAAgDa,SAAhD;AAHE,OAHV;AAAA;AAAA,aASsBC,eAAeC,eAAf,CAA+BX,EAA/B,CATtB;;AAAA;AASKY,cATL;;;AAWCC,cAAQC,GAAR,CAAY,8BAA8BF,SAASG,cAAnD;;AAXD;AAAA,aAaoB,IAAIC,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACxDrB,YAAKsB,GAAL,CAASC,qBAAT,CAA+BR,SAASG,cAAxC,EACEM,IADF,CACO,SADP,EACkB,UAASC,OAAT,EAAiB;AACjC,YAAIR,MAAMQ,QAAQC,IAAR,CAAa,CAAb,CAAV;AACA,YAAIC,QAAQV,IAAIW,MAAJ,CAAW,CAAX,CAAZ;AACA,YAAIC,UAAU,OAAKF,MAAMG,SAAN,CAAgB,EAAhB,CAAnB;AACAd,gBAAQC,GAAR,CAAY,mBAAmBY,OAA/B;AACAT,gBAAQS,OAAR;AACA,QAPF,EAQEE,EARF,CAQK,iBARL,EAQwBf,QAAQC,GARhC;AASA,OAVkB,CAbpB;;AAAA;AAaKe,YAbL;;;AAyBChB,cAAQC,GAAR,CAAY,kCAAkCe,MAA9C;;AAEA7B,WAAK;AACJC,YAAMJ,KAAKC,KAAL,CAAWI,KAAX,CAAiB,MAAjB,CADF;AAEJC,WAAI0B,MAFA;AAGJC,cAAOjC,KAAKC,KAAL,CAAWI,KAAX,CAAiB,mBAAjB;AAHH,OAAL;;AA3BD;AAAA,aAiCkBQ,eAAeC,eAAf,CAA+BX,EAA/B,CAjClB;;AAAA;AAiCCY,cAjCD;;;AAmCCC,cAAQC,GAAR,CAAY,8BAA8BF,SAASG,cAAnD;;AAnCD;AAAA,aAqCO,IAAIC,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AAC3CrB,YAAKsB,GAAL,CAASC,qBAAT,CAA+BR,SAASG,cAAxC,EACEM,IADF,CACO,SADP,EACkB,UAASC,OAAT,EAAiB;AACjCL;AACA,QAHF,EAIEW,EAJF,CAIK,iBAJL,EAIwBf,QAAQC,GAJhC,EAKEc,EALF,CAKK,OALL,EAKcf,QAAQkB,KALtB;AAMA,OAPK,CArCP;;AAAA;AAAA;AAAA,aA8CuBC,mBAAmBtC,QAAnB,EAA6BmC,MAA7B,CA9CvB;;AAAA;AA8CUI,UA9CV;AAAA,uCA+CWA,IA/CX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,E;;iBAAeC,a;;;;;;sFAkDf,kBAA4BC,eAA5B;AAAA;AAAA;AAAA;AAAA;AAAA;AACKC,oBADL,GACsBC,cAAcC,iBAAd,CAAgCH,eAAhC,CADtB;AAAA;AAAA,aAEuBC,eAAe7B,OAAf,CAAuBgC,SAAvB,GAAmCC,IAAnC,EAFvB;;AAAA;AAEKD,eAFL;AAAA,wCAIQA,SAJR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,E;;iBAAeE,Y;;;;;;;AAjGf,IAAMC,YAAYC,QAAQ,yBAAR,CAAlB;AACA,IAAMN,gBAAgBM,QAAQ,iBAAR,CAAtB;AACA,IAAM9C,OAAOwC,cAAcxC,IAA3B;AACA,IAAM+C,iBAAiBP,cAAcO,cAArC;AACA,IAAMlC,iBAAiB2B,cAAc3B,cAArC;AACA,IAAMJ,kBAAkB+B,cAAc/B,eAAtC;AACA,IAAMF,iBAAiBiC,cAAcjC,cAArC;;AAEA;AACA,IAAMyC,YAAY,IAAIH,SAAJ,CAAc;AAC9BI,YAAW,WADmB;AAE9BC,cAAa;AACb;AAH8B,CAAd,CAAlB;;AAMA;;;AAGA,IAAMC,WAAW,SAAXA,QAAW,GAAM;AACrB,KAAMC,QAAQJ,UAAUK,WAAV,CAAsB,MAAtB,EACXC,KADW,CACL,SADK,EACM,EAAEC,YAAY,IAAd,EADN,EAEXC,KAFW,CAEL,EAFK,CAAd;;AAIA,QAAOR,UAAUS,QAAV,CAAmBL,KAAnB,EACJM,IADI,CACC,UAACC,OAAD,EAAa;AACjB,MAAMC,WAAWD,QAAQ,CAAR,CAAjB;AACA,SAAOC,SAASC,GAAT,CAAa,UAACC,MAAD;AAAA,yBAAyBA,OAAOjE,QAAhC,mBAAsDiE,OAAOC,gBAA7D;AAAA,GAAb,CAAP;AACD,EAJI,CAAP;AAKD,CAVD;;AAYA,IAAM5B,qBAAqB,SAArBA,kBAAqB,CAACtC,QAAD,EAAWyC,eAAX,EAA+B;AACxD;AACA;AACA,KAAM0B,UAAUhB,UAAUiB,GAAV,CAAc,CAAC,MAAD,EAASpE,QAAT,CAAd,CAAhB;AACA,QAAO,IAAIsB,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AAC3C2B,YAAUkB,GAAV,CAAcF,OAAd,EAAuBN,IAAvB,CAA4B,mBAAW;AACrC,OAAMI,SAASH,QAAQ,CAAR,CAAf;AACAG,UAAOC,gBAAP,GAA0BzB,eAA1B;AACAU,aAAUmB,MAAV,CAAiBL,MAAjB,EAAyBJ,IAAzB,CAA8B,YAAM;AAClC;AACA1C,YAAQC,GAAR,CAAY,mCAAmCpB,QAA/C;AACAuB,YAAQ0C,MAAR;AACD,IAJD;AAKD,GARD;AASD,EAVM,CAAP;AAWD,CAfD;;QA2EIX,Q,GAAAA,Q;QAAUd,a,GAAAA,a;QAAeO,Y,GAAAA,Y","file":"account.js","sourcesContent":["const Datastore = require('@google-cloud/datastore');\r\nconst web3interface = require('./web3interface');\r\nconst web3 = web3interface.web3;\r\nconst ProxyWalletABI = web3interface.ProxyWalletABI;\r\nconst signingAccount = web3interface.signingAccount;\r\nconst FactoryContract = web3interface.FactoryContract;\r\nconst FactoryAddress = web3interface.FactoryAddress;\r\n\r\n// Creates a client\r\nconst datastore = new Datastore({\r\n  projectId: 'tap-trust',\r\n  keyFilename: 'service_account.json'\r\n  // service_account.json is not included in git repository\r\n});\r\n\r\n/**\r\n * Retrieve the latest 10 user records from the database.\r\n */\r\nconst getUsers = () => {\r\n  const query = datastore.createQuery('User')\r\n    .order('created', { descending: true })\r\n    .limit(10);\r\n\r\n  return datastore.runQuery(query)\r\n    .then((results) => {\r\n      const entities = results[0];\r\n      return entities.map((entity) => `Username: ${entity.username}, Address: ${entity.contract_address}`);\r\n    });\r\n}\r\n\r\nconst saveAccountAddress = (username, contractAddress) => {\r\n  // Right now the public key and username are already saved from the TapTrust python server.\r\n  // Only the contract address needs to be saved at this time.\r\n  const userKey = datastore.key(['User', username]);\r\n  return new Promise(function(resolve, reject) {\r\n    datastore.get(userKey).then(results => {\r\n      const entity = results[0];\r\n      entity.contract_address = contractAddress;\r\n      datastore.upsert(entity).then(() => {\r\n        // Entity updated successfully.\r\n        console.log('successfuly saved address for ' + username);\r\n        resolve(entity);\r\n      });\r\n    });\r\n  });\r\n};\r\n\r\nasync function createAccount(username, publicKey){\r\n\tvar pubKey = web3.utils.hexToBytes(publicKey);\r\n\t\r\n\tvar tx = {\r\n\t\tgas:  web3.utils.toHex(3000000),\r\n\t\tto: FactoryAddress, \r\n\t\tdata: FactoryContract.methods.createNewWallet(pubKey).encodeABI(),\r\n\t};\r\n\t\r\n\tvar signedTx = await signingAccount.signTransaction(tx);\r\n\t\r\n\tconsole.log(\"Sending Raw Transaction: \" + signedTx.rawTransaction);\r\n\t\r\n\tvar result = await new Promise(function(resolve, reject) {\r\n\t\tweb3.eth.sendSignedTransaction(signedTx.rawTransaction)\r\n\t\t\t.once('receipt', function(receipt){\r\n\t\t\t\tvar log = receipt.logs[0];\r\n\t\t\t\tvar topic = log.topics[1];\r\n\t\t\t\tvar address = \"0x\"+topic.substring(26);\r\n\t\t\t\tconsole.log(\"found address \" + address);\r\n\t\t\t\tresolve(address);\r\n\t\t\t})\r\n\t\t\t.on('transactionHash', console.log);\r\n\t});\r\n\t\r\n\tconsole.log('Contract created at address: ' + result);\r\n\t\r\n\ttx = {\r\n\t\tgas:  web3.utils.toHex(100000),\r\n\t\tto: result,\r\n\t\tvalue: web3.utils.toHex('10000000000000000')\r\n\t};\r\n\t\r\n\tsignedTx = await signingAccount.signTransaction(tx);\r\n\t\r\n\tconsole.log(\"Sending Raw Transaction: \" + signedTx.rawTransaction);\r\n\t\r\n\tawait new Promise(function(resolve, reject) {\r\n\t\tweb3.eth.sendSignedTransaction(signedTx.rawTransaction)\r\n\t\t\t.once('receipt', function(receipt){\r\n\t\t\t\tresolve();\r\n\t\t\t})\r\n\t\t\t.on('transactionHash', console.log)\r\n\t\t\t.on('error', console.error);\r\n\t});\r\n\r\n    const user = await saveAccountAddress(username, result);\r\n    return user;\r\n}\r\n\r\nasync function getUserNonce(contractAddress){\r\n\tvar WalletContract = web3interface.getWalletContract(contractAddress);\r\n\tvar nextNonce = await WalletContract.methods.nextNonce().call();\r\n\t\r\n\treturn nextNonce;\r\n}\r\n\r\nexport {\r\n    getUsers, createAccount, getUserNonce\r\n};\r\n"]}