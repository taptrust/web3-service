{"version":3,"sources":["../src/account.js"],"names":["username","publicKey","pubKey","web3","utils","hexToBytes","web3interface","nextNonce","tx","gas","toHex","to","process","env","WALLET_FACTORY","data","FactoryContract","methods","createNewWallet","encodeABI","signingAccount","signTransaction","signedTx","console","log","rawTransaction","Promise","resolve","reject","eth","sendSignedTransaction","once","receipt","logs","topic","topics","address","substring","on","result","saveAccountAddress","user","createAccount","contractAddress","WalletContract","getWalletContract","call","getUserNonce","Tx","require","Datastore","ProxyWalletABI","datastore","projectId","keyFilename","getUsers","query","createQuery","order","descending","limit","runQuery","then","results","entities","map","entity","contract_address","userKey","key","get","upsert"],"mappings":"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","file":"account.js","sourcesContent":["const Tx = require('ethereumjs-tx');\r\nconst Datastore = require('@google-cloud/datastore');\r\nconst web3interface = require('./web3interface');\r\nconst web3 = web3interface.web3;\r\nconst ProxyWalletABI = web3interface.ProxyWalletABI;\r\nconst signingAccount = web3interface.signingAccount;\r\nconst FactoryContract = web3interface.FactoryContract;\r\n\r\n// Creates a client\r\nconst datastore = new Datastore({\r\n  projectId: 'tap-trust',\r\n  keyFilename: 'service_account.json'\r\n  // service_account.json is not included in git repository\r\n});\r\n\r\n/**\r\n * Retrieve the latest 10 user records from the database.\r\n */\r\nconst getUsers = () => {\r\n  const query = datastore.createQuery('User')\r\n    .order('created', { descending: true })\r\n    .limit(10);\r\n\r\n  return datastore.runQuery(query)\r\n    .then((results) => {\r\n      const entities = results[0];\r\n      return entities.map((entity) => `Username: ${entity.username}, Address: ${entity.contract_address}`);\r\n    });\r\n}\r\n\r\nconst saveAccountAddress = (username, contractAddress) => {\r\n  // Right now the public key and username are already saved from the TapTrust python server.\r\n  // Only the contract address needs to be saved at this time.\r\n  const userKey = datastore.key(['User', username]);\r\n  return new Promise(function(resolve, reject) {\r\n    datastore.get(userKey).then(results => {\r\n      const entity = results[0];\r\n      entity.contract_address = contractAddress;\r\n      datastore.upsert(entity).then(() => {\r\n        // Entity updated successfully.\r\n        console.log('successfuly saved address for ' + username);\r\n        resolve(entity);\r\n      });\r\n    });\r\n  });\r\n};\r\n\r\nasync function createAccount(username, publicKey){\r\n\tvar pubKey = web3.utils.hexToBytes(publicKey);\r\n\tvar nextNonce = await web3interface.nextNonce();\r\n\t\r\n\tvar tx = {\r\n\t\tgas:  web3.utils.toHex(3000000),\r\n\t\tto: process.env.WALLET_FACTORY, \r\n\t\tdata: FactoryContract.methods.createNewWallet(pubKey).encodeABI(),\r\n\t};\r\n\t\r\n\tvar signedTx = await signingAccount.signTransaction(tx);\r\n\t\r\n\tconsole.log(\"Sending Raw Transaction: \" + signedTx.rawTransaction);\r\n\t\r\n\tvar result = await new Promise(function(resolve, reject) {\r\n\t\tweb3.eth.sendSignedTransaction(signedTx.rawTransaction)\r\n\t\t\t.once('receipt', function(receipt){\r\n\t\t\t\tvar log = receipt.logs[0];\r\n\t\t\t\tvar topic = log.topics[1];\r\n\t\t\t\tvar address = \"0x\"+topic.substring(26);\r\n\t\t\t\tconsole.log(\"found\" + address);\r\n\t\t\t\tresolve(address);\r\n\t\t\t})\r\n\t\t\t.on('transactionHash', console.log);\r\n\t});\r\n\t\r\n\tconsole.log('Contract created at address: ' + result);\r\n\r\n    const user = await saveAccountAddress(username, result);\r\n    return user;\r\n}\r\n\r\nasync function getUserNonce(contractAddress){\r\n\tvar WalletContract = web3interface.getWalletContract(contractAddress);\r\n\tvar nextNonce = await WalletContract.methods.nextNonce().call();\r\n\t\r\n\treturn nextNonce;\r\n}\r\n\r\nexport {\r\n    getUsers, createAccount, getUserNonce\r\n};\r\n"]}